{% extends 'base.html' %}
{% block title %}Deliberacion de Aspirantes{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/coordinator/deliberation.css') }}?v={{ static_version }}">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
        <div>
          <h1 class="h3 mb-2">
            <i class="bi bi-people-fill me-2"></i>Deliberacion de Aspirantes
          </h1>
          <p class="text-muted mb-0">Gestiona el proceso de admision de aspirantes</p>
        </div>
      </div>

      <!-- Selector de programa -->
      {% if coordinator_programs|length > 1 %}
      <div class="card mb-4">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-4">
              <label class="form-label fw-bold">Programa</label>
              <select class="form-select" id="programSelector">
                {% for program in coordinator_programs %}
                <option value="{{ program.id }}" {% if selected_program and program.id == selected_program.id %}selected{% endif %}>
                  {{ program.name }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-8">
              <div id="statsContainer" class="d-flex flex-wrap gap-3 mt-3 mt-md-0">
                <!-- Stats cards will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>
      {% else %}
      <input type="hidden" id="programSelector" value="{{ selected_program.id if selected_program else '' }}">
      {% endif %}

      <!-- Tabs por estado -->
      <ul class="nav nav-tabs mb-4" id="statusTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="pending-interview-tab" data-bs-toggle="tab"
                  data-bs-target="#pending-interview-pane" data-status="pending_interview" type="button" role="tab">
            <i class="bi bi-calendar-check me-2"></i>Con Entrevista Agendada
            <span class="badge bg-secondary ms-2" id="pendingInterviewCount">0</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="interview-completed-tab" data-bs-toggle="tab"
                  data-bs-target="#interview-completed-pane" data-status="interview_completed" type="button" role="tab">
            <i class="bi bi-hourglass-split me-2"></i>Entrevista Completada
            <span class="badge bg-warning text-dark ms-2" id="interviewCompletedCount">0</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="deliberation-tab" data-bs-toggle="tab"
                  data-bs-target="#deliberation-pane" data-status="deliberation" type="button" role="tab">
            <i class="bi bi-chat-square-dots me-2"></i>En Deliberacion
            <span class="badge bg-info ms-2" id="deliberationCount">0</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="accepted-tab" data-bs-toggle="tab"
                  data-bs-target="#accepted-pane" data-status="accepted" type="button" role="tab">
            <i class="bi bi-check-circle me-2"></i>Aceptados
            <span class="badge bg-success ms-2" id="acceptedCount">0</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="rejected-tab" data-bs-toggle="tab"
                  data-bs-target="#rejected-pane" data-status="rejected" type="button" role="tab">
            <i class="bi bi-x-circle me-2"></i>Rechazados
            <span class="badge bg-danger ms-2" id="rejectedCount">0</span>
          </button>
        </li>
      </ul>

      <!-- Contenido de tabs -->
      <div class="tab-content" id="statusTabsContent">
        <!-- Con Entrevista Agendada -->
        <div class="tab-pane fade show active" id="pending-interview-pane" role="tabpanel">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Aspirantes con Entrevista Agendada</h5>
              <small class="text-muted">Marcar como entrevista completada</small>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="pendingInterviewTable">
                  <thead class="table-light">
                    <tr>
                      <th>Aspirante</th>
                      <th>Email</th>
                      <th>CURP</th>
                      <th class="text-center">Fecha Registro</th>
                      <th class="text-center">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="5" class="text-center py-4 text-muted">Cargando...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Entrevista Completada -->
        <div class="tab-pane fade" id="interview-completed-pane" role="tabpanel">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Aspirantes con Entrevista Completada</h5>
              <small class="text-muted">Listos para iniciar deliberacion</small>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="interviewCompletedTable">
                  <thead class="table-light">
                    <tr>
                      <th>Aspirante</th>
                      <th>Email</th>
                      <th>CURP</th>
                      <th class="text-center">Fecha Registro</th>
                      <th class="text-center">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="5" class="text-center py-4 text-muted">Cargando...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- En Deliberacion -->
        <div class="tab-pane fade" id="deliberation-pane" role="tabpanel">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Aspirantes en Proceso de Deliberacion</h5>
              <small class="text-muted">Pendientes de decision</small>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="deliberationTable">
                  <thead class="table-light">
                    <tr>
                      <th>Aspirante</th>
                      <th>Email</th>
                      <th class="text-center">Inicio Deliberacion</th>
                      <th class="text-center">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="4" class="text-center py-4 text-muted">Cargando...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Aceptados -->
        <div class="tab-pane fade" id="accepted-pane" role="tabpanel">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Aspirantes Aceptados</h5>
              <small class="text-muted">Admitidos al programa</small>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="acceptedTable">
                  <thead class="table-light">
                    <tr>
                      <th>Aspirante</th>
                      <th>Email</th>
                      <th class="text-center">Fecha Decision</th>
                      <th>Notas</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="4" class="text-center py-4 text-muted">Cargando...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Rechazados -->
        <div class="tab-pane fade" id="rejected-pane" role="tabpanel">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Aspirantes Rechazados</h5>
              <small class="text-muted">No admitidos</small>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="rejectedTable">
                  <thead class="table-light">
                    <tr>
                      <th>Aspirante</th>
                      <th>Email</th>
                      <th class="text-center">Tipo</th>
                      <th class="text-center">Fecha</th>
                      <th>Notas</th>
                      <th class="text-center">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="6" class="text-center py-4 text-muted">Cargando...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block modals %}
<!-- Modal: Decision de Deliberacion -->
<div class="modal fade" id="decisionModal" tabindex="-1" data-bs-backdrop="static">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="decisionModalTitle">Tomar Decision</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="decisionUserId">
        <input type="hidden" id="decisionProgramId">
        <input type="hidden" id="decisionAction">

        <div class="mb-3">
          <label class="form-label fw-bold">Aspirante</label>
          <p class="mb-0" id="decisionApplicantName">-</p>
        </div>

        <!-- Seccion para rechazo -->
        <div id="rejectionSection" style="display: none;">
          <div class="mb-3">
            <label class="form-label fw-bold">Tipo de Rechazo</label>
            <select class="form-select" id="rejectionType">
              <option value="full">Rechazo definitivo</option>
              <option value="partial">Solicitar correcciones</option>
            </select>
          </div>
          <div class="mb-3" id="correctionSection" style="display: none;">
            <label class="form-label fw-bold">Correcciones requeridas</label>
            <textarea class="form-control" id="correctionRequired" rows="3"
                      placeholder="Describe las correcciones que debe realizar el aspirante..."></textarea>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Notas (opcional)</label>
          <textarea class="form-control" id="decisionNotes" rows="3"
                    placeholder="Observaciones sobre la decision..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="confirmDecisionBtn">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Confirmacion de Inicio de Deliberacion -->
<div class="modal fade" id="startDeliberationModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Iniciar Deliberacion</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="startDelibUserId">
        <input type="hidden" id="startDelibProgramId">
        <p>Deseas iniciar el proceso de deliberacion para <strong id="startDelibApplicantName">-</strong>?</p>
        <p class="text-muted small">Una vez iniciada, podras tomar una decision de aceptacion o rechazo.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="confirmStartDelibBtn">Iniciar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/coordinator/deliberation.js') }}?v={{ static_version }}"></script>
{% endblock %}
