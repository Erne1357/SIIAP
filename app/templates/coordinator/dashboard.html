{% extends 'base.html' %}
{% block title %}Coordinación - Gestión de Estudiantes{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .student-avatar { width: 32px; height: 32px; }
  .progress { height: 8px; }
  .table-secondary { opacity: 0.6; }
  .btn-group-sm .btn { padding: 0.25rem 0.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
        <div>
          <h1 class="h3 mb-2">Gestión de Estudiantes</h1>
          <p class="text-muted mb-0">Supervisa el progreso y gestiona documentos de tus estudiantes</p>
        </div>
        <div class="mt-3 mt-md-0">
          <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadForStudentModal">
            <i class="fas fa-upload me-2"></i>Subir por Estudiante
          </button>
        </div>
      </div>

      <!-- Filtros y controles -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">
            <div class="col-12 col-md-3">
              <label class="form-label">Programa</label>
              <select class="form-select" id="programFilter">
                <option value="">Todos los programas</option>
                <!-- Se llenará dinámicamente -->
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Fase</label>
              <select class="form-select" id="phaseFilter">
                <option value="">Todas las fases</option>
                <option value="admission">Admisión</option>
                <option value="permanence">Permanencia</option>
                <option value="conclusion">Conclusión</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <label class="form-label">Estado</label>
              <select class="form-select" id="statusFilter">
                <option value="">Todos los estados</option>
                <option value="pending">Documentos Pendientes</option>
                <option value="review">En Revisión</option>
                <option value="approved">Completado</option>
                <option value="rejected">Con Rechazos</option>
              </select>
            </div>
            <div class="col-12 col-md-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="showOtherPrograms">
                <label class="form-check-label" for="showOtherPrograms">
                  Ver otros programas (solo consulta)
                </label>
              </div>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-12 col-md-6">
              <div class="input-group">
                <input type="search" class="form-control" placeholder="Buscar estudiante..." id="studentSearch">
                <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                  <i class="fas fa-search"></i>
                </button>
              </div>
            </div>
            <div class="col-12 col-md-6 text-md-end mt-2 mt-md-0">
              <button class="btn btn-outline-primary" id="refreshBtn">
                <i class="fas fa-sync-alt me-1"></i>Actualizar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Pestañas por fase -->
      <ul class="nav nav-tabs mb-4" id="phaseTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="admission-tab" data-bs-toggle="tab" data-bs-target="#admission-pane"
            type="button" role="tab">
            <i class="fas fa-user-plus me-2"></i>Admisión
            <span class="badge bg-primary ms-2" id="admissionCount">0</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="permanence-tab" data-bs-toggle="tab" data-bs-target="#permanence-pane"
            type="button" role="tab">
            <i class="fas fa-graduation-cap me-2"></i>Permanencia
            <span class="badge bg-info ms-2" id="permanenceCount">0</span>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="conclusion-tab" data-bs-toggle="tab" data-bs-target="#conclusion-pane"
            type="button" role="tab">
            <i class="fas fa-award me-2"></i>Conclusión
            <span class="badge bg-success ms-2" id="conclusionCount">0</span>
          </button>
        </li>
      </ul>

      <!-- Contenido de las pestañas -->
      <div class="tab-content" id="phaseTabsContent">
        <!-- Admisión -->
        <div class="tab-pane fade show active" id="admission-pane" role="tabpanel">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Estudiantes en Proceso de Admisión</h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="admissionTable">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 50px;"></th>
                      <th>Estudiante</th>
                      <th>Programa</th>
                      <th class="text-center" style="width: 120px;">Progreso</th>
                      <th class="text-center" style="width: 140px;">Documentos</th>
                      <th class="text-center" style="width: 100px;">Estado</th>
                      <th style="width: 150px;">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="7" class="text-center py-4 text-muted">Cargando estudiantes...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Permanencia -->
        <div class="tab-pane fade" id="permanence-pane" role="tabpanel">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Estudiantes en Permanencia</h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="permanenceTable">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 50px;"></th>
                      <th>Estudiante</th>
                      <th>Programa</th>
                      <th class="text-center">Semestre</th>
                      <th class="text-center">Avance</th>
                      <th class="text-center">Estado</th>
                      <th style="width: 150px;">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="7" class="text-center py-4 text-muted">Cargando estudiantes...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Conclusión -->
        <div class="tab-pane fade" id="conclusion-pane" role="tabpanel">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Estudiantes en Proceso de Conclusión</h5>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0" id="conclusionTable">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 50px;"></th>
                      <th>Estudiante</th>
                      <th>Programa</th>
                      <th class="text-center">Etapa</th>
                      <th class="text-center">Progreso</th>
                      <th class="text-center">Estado</th>
                      <th style="width: 150px;">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr><td colspan="7" class="text-center py-4 text-muted">Cargando estudiantes...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block modals %}
<!-- Modal: Detalles del Estudiante -->
<div class="modal fade" id="studentDetailsModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <div class="d-flex align-items-center">
          <img src="" alt="Avatar" class="rounded-circle me-3" style="width: 48px; height: 48px;" id="modalStudentAvatar">
          <div>
            <h5 class="modal-title mb-0" id="modalStudentName">Cargando...</h5>
            <small class="text-muted" id="modalStudentEmail"></small><br>
            <small class="text-muted"><i class="fas fa-graduation-cap me-1"></i><span id="modalStudentProgram"></span></small>
          </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="modalContent">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3" id="studentDetailsTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="general-tab" data-bs-toggle="tab" 
                    data-bs-target="#general-pane" type="button" role="tab">
              <i class="fas fa-user me-1"></i>General
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="documents-tab" data-bs-toggle="tab" 
                    data-bs-target="#documents-pane" type="button" role="tab">
              <i class="fas fa-file-alt me-1"></i>Documentos
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="interview-tab" data-bs-toggle="tab" 
                    data-bs-target="#interview-pane" type="button" role="tab">
              <i class="fas fa-calendar-alt me-1"></i>Entrevista
            </button>
          </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="studentDetailsTabContent">
          <div class="tab-pane fade show active" id="general-pane" role="tabpanel">
            <div id="generalTabContent"></div>
          </div>
          <div class="tab-pane fade" id="documents-pane" role="tabpanel">
            <div id="documentsTabContent"></div>
          </div>
          <div class="tab-pane fade" id="interview-pane" role="tabpanel">
            <div id="interviewTabContent"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal para subir documento por estudiante -->
<div class="modal fade" id="uploadForStudentModal" tabindex="-1" aria-labelledby="uploadForStudentLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form class="modal-content" data-coordinator-upload="true">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadForStudentLabel">Subir Documento por Estudiante</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label for="targetStudent" class="form-label">Estudiante</label>
            <select class="form-select" id="targetStudent" name="student_id" required>
              <option value="">Seleccionar estudiante...</option>
            </select>
          </div>
          <div class="col-12 col-md-6">
            <label for="targetProgram" class="form-label">Programa</label>
            <input type="text" class="form-control" id="targetProgram" readonly placeholder="Automático según estudiante">
          </div>
          <div class="col-12">
            <label for="targetArchive" class="form-label">Archivo a subir</label>
            <select class="form-select" id="targetArchive" name="archive_id" required disabled>
              <option value="">Primero selecciona un estudiante</option>
            </select>
          </div>
          <div class="col-12">
            <label for="coordinatorFile" class="form-label">Archivo</label>
            <input type="file" class="form-control" id="coordinatorFile" name="file" accept=".pdf" required>
            <div class="form-text">Solo PDF, máximo 3MB</div>
          </div>
          <div class="col-12">
            <label for="coordinatorNotes" class="form-label">Notas del coordinador (opcional)</label>
            <textarea class="form-control" id="coordinatorNotes" name="notes" rows="3" 
                      placeholder="Observaciones sobre el documento subido..."></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Subir Documento</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/coordinator/dashboard.js')}}?v={{ static_version }}"></script>
{% endblock %}