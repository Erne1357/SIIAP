<table class="table table-hover align-middle" id="archiveTable">
  <thead class="table-light">
    <tr>
      <th style="width:32px;"></th>
      <th>Documento</th>
      <th class="d-none d-md-table-cell" style="width:160px;">Plantilla</th>
      <th style="width:120px;">Estado</th>
      <th style="width:140px;">Acciones</th>
      <th class="d-none d-lg-table-cell">Observaciones</th>
      <th class="d-none d-lg-table-cell" style="width:130px;">Revisado</th>
    </tr>
  </thead>

  <tbody>
    {% for arch in step.archives %}
    {% set sub = subs.get(arch.id) %}
    {% set row_id = "row-" ~ arch.id %}

    <!-- Fila principal -->
    <tr>
      <td><i class="far fa-file-alt text-secondary"></i></td>
      <td>
        <a class="text-decoration-none" data-bs-toggle="collapse" href="#{{ row_id }}" role="button">
          {{ arch.name }}
          <i class="fas fa-chevron-down small ms-1"></i>
        </a>
      </td>

      <!-- Plantilla -->
      <td class="d-none d-md-table-cell">
        {% if arch.is_downloadable and arch.file_path %}
        <a class="btn btn-link btn-sm" href="{{ url_for('api_files.template', filename=arch.file_path) }}"
          target="_blank">Descargar</a>
        {% else %} — {% endif %}
      </td>

      <!-- Estado -->
      <td>
        {% if not sub %}
        <span class="badge bg-secondary">Pendiente</span>
        {% elif sub.status == 'approved' %}
        <span class="badge bg-success">Aprobado</span>
        {% elif sub.status == 'rejected' %}
        <span class="badge bg-danger">Rechazado</span>
        {% else %}
        <span class="badge bg-warning text-dark">En Revisión</span>
        {% endif %}
      </td>

      <!-- Acciones -->
      <td class="d-flex flex-column flex-md-row gap-1">
        {% if arch.is_uploadable %}
        {% if sub %}
        <a class="btn btn-outline-primary btn-sm" 
           title="Ver" 
           href="{{ url_for('api_files.user_doc',
                           user_id=current_user.id,
                           phase='admission',
                           filename=sub.file_path.split('/')[-1]) }}"
           target="_blank">
           <!-- icnono de ver  -->
          <i class="bi bi-eye"></i>
          <span class="d-none d-md-inline"></span>
        </a>
        {% endif %}

        <button class="btn btn-outline-success btn-sm" 
                title="Subir / Reemplazar" 
                data-bs-toggle="modal"
                data-bs-target="#uploadModal" 
                data-archive="{{ arch.id }}" 
                data-step="{{ step.id }}"
                data-archive-name="{{ arch.name }}"
                data-has-existing="{{ 'true' if sub else 'false' }}"
                data-existing-filename="{{ sub.file_path.split('/')[-1] if sub else '' }}"
                data-existing-date="{{ sub.upload_date.strftime('%d/%m/%Y %H:%M') if sub else '' }}">
          <i class="fas fa-upload"></i>
          <span class="d-none d-md-inline"></span>
        </button>

        {% if sub %}
        <button class="btn btn-outline-danger btn-sm" 
                title="Borrar" 
                data-delete-submission="{{ sub.id }}"
                data-step="{{ step.id }}">
          <i class="fas fa-trash"></i>
        </button>
        {% endif %}
        {% else %}
        <span class="text-muted small"><i class="fas fa-ban"></i> Sin acciones</span>
        {% endif %}
      </td>

      <!-- Observaciones -->
      <td class="d-none d-lg-table-cell">
        {% if sub and sub.reviewer_comment %}
        <div class="text-truncate" style="max-width: 150px;" title="{{ sub.reviewer_comment }}">
          {{ sub.reviewer_comment }}
        </div>
        {% else %}
        —
        {% endif %}
      </td>

      <!-- Fecha de revisión -->
      <td class="d-none d-lg-table-cell">
        {% if sub and sub.review_date %}
        {{ sub.review_date.strftime('%d/%m/%Y') }}
        {% else %}
        —
        {% endif %}
      </td>
    </tr>

    <!-- Fila descripción colapsable -->
    <tr id="{{ row_id }}" class="collapse">
      <td></td>
      <td colspan="6" class="text-muted small px-3 py-2">
        <div class="bg-light p-2 rounded">
          {{ arch.description or 'Sin descripción disponible.' }}
        </div>
        <!-- En móvil mostramos info adicional que está oculta -->
        <div class="d-lg-none mt-2">
          {% if sub and sub.reviewer_comment %}
          <div><strong>Observaciones:</strong> {{ sub.reviewer_comment }}</div>
          {% endif %}
          {% if sub and sub.review_date %}
          <div><strong>Revisado:</strong> {{ sub.review_date.strftime('%d/%m/%Y') }}</div>
          {% endif %}
        </div>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>