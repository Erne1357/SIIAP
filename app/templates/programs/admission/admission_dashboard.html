{# app/templates/programs/admission/admission_dashboard.html #}
{% extends 'base.html' %}
{% block title %}Admisión – {{ program.name }}{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/program/admission.css') }}?v={{ static_version }}">
{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Info/intro -------------------------------------------------- -->
  <div class="alert alert-info shadow-sm mb-4" role="alert">
    <h5 class="mb-2">Proceso de Admisión</h5>
    <p class="mb-0">
      Sube los documentos requeridos en cada paso. Los siguientes pasos
      se desbloquearán cuando todos los archivos del paso anterior estén aprobados.
      <br>
      <strong><i>Para ver la descripción de los archivos, haz clic en el nombre del archivo.</i></strong>
    </p>
  </div>

  <!-- Tabs nav ----------------------------------------------------- -->
  <ul class="nav nav-tabs mb-3" id="stepTab" role="tablist">
    {% for step in steps %}
    {% set locked = lock_info[step.id] %}
    {% set seq = step.program_steps[0].sequence %}
    {% set state = step_states[step.id] %}
    <li class="nav-item" role="presentation">
      <button class="nav-link
               {% if loop.first %}active{% endif %}
               {% if state=='approved' %}text-success{% elif state=='rejected' %}text-danger{% elif state=='review' %}text-warning{% endif %}
               {% if locked %}disabled{% endif %}" id="tab-{{ step.id }}" data-bs-toggle="tab"
        data-bs-target="#pane-{{ step.id }}" type="button" role="tab">
        {% if seq != 0 %}{{ seq }}. {% endif %}{{ step.name }}
        {# Iconos de estado #}
        {%if seq !=0 %}
        {% if locked %}
        <i class="fas fa-lock ms-1"></i>
        {% elif state=='approved' %}
        <i class="fas fa-check-circle ms-1 text-success"></i>
        {% elif state=='rejected' %}
        <i class="fas fa-times-circle ms-1 text-danger"></i>
        {% elif state=='pending' %}
        <i class="fas fa-exclamation-circle ms-1 text-warning"></i>
        {% endif %}
        {% endif %}
      </button>
    </li>
    {% endfor %}
  </ul>

  <!-- Tabs content ------------------------------------------------- -->
  <div class="tab-content">
    {% for step in steps %}
    {% set locked = lock_info[step.id] %}
    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="pane-{{ step.id }}" role="tabpanel">
      {% if locked %}
      <div class="alert alert-warning">Completa y aprueba el paso anterior.</div>
      {% else %}
      {% include 'programs/admission/_archive_table.html' %}
      {% endif %}
    </div>
    {% endfor %}
  </div>
</div>

<!-- Modal para subir archivos -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" enctype="multipart/form-data" class="modal-content" data-admission-upload="true">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadLabel">Subir Documento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="archive_id" id="archiveIdInput">
        <input type="hidden" name="program_id" id="programIdInput" value="{{ program.id }}">
        
        <!-- Información del archivo existente -->
        <div id="existingFileInfo" class="alert alert-info d-none">
          <h6><i class="fas fa-info-circle"></i> Archivo Existente</h6>
          <p class="mb-1"><strong>Documento:</strong> <span id="existingArchiveName"></span></p>
          <p class="mb-1"><strong>Archivo actual:</strong> <span id="existingFilename"></span></p>
          <p class="mb-0"><strong>Subido el:</strong> <span id="existingDate"></span></p>
          <hr>
          <p class="mb-0 small text-warning">
            <i class="fas fa-exclamation-triangle"></i> 
            Al subir un nuevo archivo, se reemplazará el anterior de forma permanente.
          </p>
        </div>

        <div class="mb-3">
          <label class="form-label">Seleccionar Archivo</label>
          <input type="file" class="form-control" name="file" required accept=".pdf">
          <div class="form-text">
            Formatos permitidos: PDF únicamente. Tamaño máximo: 3MB.
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary" id="uploadSubmitBtn">
          <span id="uploadBtnText">Subir</span>
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal para solicitar prórroga -->
<div class="modal fade" id="extensionModal" tabindex="-1" aria-labelledby="extensionLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="extensionLabel">Solicitar Prórroga</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <form id="extensionForm">
        <div class="modal-body">
          <input type="hidden" id="extensionArchiveId">
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Solicitando prórroga para: <strong id="extensionArchiveName"></strong>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Fecha solicitada (hasta cuándo necesitas)</label>
            <input type="date" class="form-control" id="extensionRequestedUntil" required>
            <div class="form-text">Selecciona una fecha realista para completar el documento.</div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">Motivo de la solicitud</label>
            <textarea class="form-control" id="extensionReason" rows="3" required
                      placeholder="Explica brevemente por qué necesitas más tiempo..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Solicitar Prórroga</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/program/admission.js') }}?v={{ static_version }}"></script>
{% endblock %}