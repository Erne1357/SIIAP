{% extends 'auth_base.html' %}
{% block title %}SIIAP – Registro de Usuario{% endblock %}

{% block body_class %}register-body{% endblock %}
{% block main_class %}register-page{% endblock %}
{% block container_class %}register-container{% endblock %}
{% block bg_class %}register-container{% endblock %}

{% block styles %}
  {{ super() }}
  <link href="{{ url_for('static', filename='css/auth/register.css') }}?v={{ static_version }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <h3 class="card-title text-center mb-3">Registro de Usuario</h3>
    <hr class="mx-3">
    <p class="text-center text-muted mb-4" style="font-size: 0.9rem;">
      Completa el formulario para crear tu cuenta. 
      <br>
      Todos los campos marcados con <span style="color:red">*</span> son obligatorios.
    </p>

    <form method="POST" id="registerForm">
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <label for="first_name" class="form-label">Nombre <span style="color:red">*</span></label>
          <input type="text" class="form-control" id="first_name" name="first_name" required>
        </div>
        <div class="col-md-4">
          <label for="last_name" class="form-label">Apellido Paterno <span style="color:red">*</span></label>
          <input type="text" class="form-control" id="last_name" name="last_name" required>
        </div>
        <div class="col-md-4">
          <label for="mother_last_name" class="form-label">Apellido Materno</label>
          <input type="text" class="form-control" id="mother_last_name" name="mother_last_name">
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label for="username" class="form-label">Usuario <span style="color:red">*</span></label>
          <input type="text" class="form-control" id="username" name="username" minlength="5" required>
        </div>
        <div class="col-md-6">
          <label for="email" class="form-label">Correo Electrónico <span style="color:red">*</span></label>
          <input type="email" class="form-control" id="email" name="email" required>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label for="password" class="form-label">Contraseña <span style="color:red">*</span></label>
          <input type="password" class="form-control" id="password" name="password" minlength="8" required>
        </div>
        <div class="col-md-6">
          <label for="confirm_password" class="form-label">Confirmar Contraseña <span style="color:red">*</span></label>
          <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
        </div>
      </div>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-success w-100">Registrarme</button>
    </form>

    <div class="mt-3 text-center">
      ¿Ya tienes cuenta? <a href="{{ url_for('pages_auth.login_page') }}" data-no-swup>Inicia Sesión</a>
    </div>
  </div>
</div>

<script>
  // Función flash consistente con el resto de la aplicación
  function flash(message, level = 'success') {
    window.dispatchEvent(new CustomEvent('flash', {
      detail: { level: level, message: message }
    }));
  }
  
  // Función para obtener CSRF token
  const getCsrf = () => {
    const el = document.querySelector('meta[name="csrf-token"]');
    return el ? el.getAttribute('content') : '';
  };
  
  const form = document.getElementById('registerForm');
  const submitBtn = form.querySelector('button[type="submit"]') || form.querySelector('button');
  
  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    
    // Validación de contraseñas
    const pwd = document.getElementById('password').value;
    const cpwd = document.getElementById('confirm_password').value;
    
    if (pwd !== cpwd) {
      flash('Las contraseñas no coinciden', 'danger');
      return;
    }
    
    // Validaciones adicionales
    const firstName = document.getElementById('first_name').value.trim();
    const lastName = document.getElementById('last_name').value.trim();
    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    
    if (!firstName || !lastName || !username || !email || !pwd) {
      flash('Por favor completa todos los campos obligatorios', 'warning');
      return;
    }
    
    if (username.length < 5) {
      flash('El nombre de usuario debe tener al menos 5 caracteres', 'warning');
      return;
    }
    
    if (pwd.length < 8) {
      flash('La contraseña debe tener al menos 8 caracteres', 'warning');
      return;
    }
    
    // Mostrar estado de carga
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Registrando...';
    submitBtn.disabled = true;
    
    try {
      const formData = new FormData(form);
      const csrf = getCsrf();
      
      const response = await fetch(form.action || window.location.href, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-CSRF-Token': csrf,
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      });
      
      console.log('Response status:', response.status);
      console.log('Response headers:', response.headers);
      console.log('Response Content-Type:', response.headers.get('Content-Type'));
      
      const contentType = response.headers.get('Content-Type');
      
      if (contentType && contentType.includes('application/json')) {
        const json = await response.json();
        console.log('Registro respuesta JSON:', json);
        
        if (!response.ok) {
          const errorMsg = json?.error || json?.message || 'Error al registrar usuario';
          flash(errorMsg, 'danger');
          return;
        }
        
        if (json.ok) {
          flash('Registro exitoso. Redirigiendo al inicio de sesión...', 'success');
          
          // Redirigir al login después de mostrar el mensaje
          setTimeout(() => {
            window.location.href = "{{ url_for('pages_auth.login_page') }}";
          }, 150);
        } else {
          const errorMsg = json?.error || 'Error al registrar usuario';
          flash(errorMsg, 'danger');
        }
      } else {
        // La respuesta es HTML, no JSON
        const htmlText = await response.text();
        console.log('Registro respuesta HTML (primeros 500 chars):', htmlText.substring(0, 500));
        flash('Error del servidor: respuesta inesperada', 'danger');
      }
      
    } catch (err) {
      console.error('Registration error:', err);
      flash('Error de red al registrar. Inténtalo nuevamente.', 'danger');
    } finally {
      // Restaurar botón
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  });
  
  // Validación en tiempo real de contraseñas
  document.getElementById('confirm_password').addEventListener('input', function() {
    const pwd = document.getElementById('password').value;
    const cpwd = this.value;
    
    if (cpwd && pwd !== cpwd) {
      this.setCustomValidity('Las contraseñas no coinciden');
      this.classList.add('is-invalid');
    } else {
      this.setCustomValidity('');
      this.classList.remove('is-invalid');
    }
  });
</script>
{% endblock %}