{% extends 'auth_base.html' %}
{% block title %}SIIAP – Iniciar Sesión{% endblock %}

{% block container_class %}login-container{% endblock %}

{% block styles %}
  {{ super() }}
  <link href="{{ url_for('static', filename='css/auth/login.css') }}?v={{ static_version }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <h3 class="card-title text-center mb-4">Iniciar Sesión</h3>
    <hr class="mx-3">

    <form id="loginForm">
      <div class="mb-3">
        <label for="username" class="form-label">Usuario</label>
        <input type="text" class="form-control" id="username" name="username" required autofocus>
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">Contraseña</label>
        <input type="password" class="form-control" id="password" name="password" required>
      </div>
      <button type="submit" class="btn btn-primary w-100 bg-tecnm">Entrar</button>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    </form>

    <div class="mt-3 text-center">
      ¿No tienes cuenta? <a href="{{ url_for('pages_auth.register_page') }}" data-no-swup>Regístrate</a>
    </div>
  </div>
</div>

<script type="module">
  import { api } from "{{ url_for('static', filename='js/api/http.js') }}?v={{ static_version }}";
  
  // Función flash consistente con el resto de la aplicación
  function flash(message, level = 'success') {
    window.dispatchEvent(new CustomEvent('flash', {
      detail: { level: level, message: message }
    }));
  }
  
  const form = document.getElementById('loginForm');
  const submitBtn = form.querySelector('button[type="submit"]');
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    
    if (!username || !password) {
      flash('Por favor completa todos los campos', 'warning');
      return;
    }
    
    // Mostrar estado de carga
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Iniciando sesión...';
    submitBtn.disabled = true;
    
    try {
      const result = await api('/auth/login', { 
        method: 'POST', 
        body: { username, password } 
      });
      
      flash('Inicio de sesión exitoso. Redirigiendo...', 'success');
      
      // Pequeño delay para mostrar el mensaje antes de redirigir
      setTimeout(() => {
        window.location.href = "{{ url_for('pages_user.dashboard') }}";
      }, 100);
      
    } catch (err) {
      console.error('Login error:', err);
      const errorMsg = err?.message || 'Error de autenticación. Verifica tus credenciales.';
      flash(errorMsg, 'danger');
    } finally {
      // Restaurar botón
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }
  });
</script>
{% endblock %}