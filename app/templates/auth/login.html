{% extends 'auth_base.html' %}
{% block title %}SIIAP – Iniciar Sesión{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth/login-register.css') }}?v={{ static_version }}">
{% endblock %}

{% block scripts %}
{{ super() }}
{% endblock %}

<!-- Sobrescritura de la barra de navegación para que no aparezca-->
{% block navbar %}{%endblock%}

{% block content %}
<!-- Banner flotante del sistema - Integrado con el header existente -->
<div class="siiapec-welcome-banner">
  <div class="banner-content">
    <span class="banner-text">Bienvenido al Sistema Integral de Información para Administración y Permanencia de
      Posgrado</span>
  </div>
</div>

<div class="auth-container">
  <div class="auth-bg">
    <div class="diseño card shadow-sm">
      <div class="card-body" style="width: 100%;">
        <h3 class="card-title text-center mb-4">Iniciar Sesión</h3>
        <hr class="mx-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for cat,msg in messages %}
        <div class="alert alert-{{ 'danger' if cat=='danger' else 'info' if cat=='info' else 'success' }}">
          {{ msg }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <form id="loginForm">
          <div class="mb-3">
            <label for="username" class="form-label">Usuario</label>
            <input type="text" class="form-control" id="username" name="username" required autofocus>
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">Contraseña</label>
            <input type="password" class="form-control" id="password" name="password" required>
          </div>
          <button type="submit" class="btn btn-primary w-100 bg-tecnm">Entrar</button>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        </form>

        <div class="mt-3 text-center">
          ¿No tienes cuenta? <a href="{{ url_for('pages_auth.register_page') }}" data-no-swup>Regístrate</a>
        </div>
      </div>
    </div>
  </div>
</div>
<script type="module">
  import { api } from "{{ url_for('static', filename='js/api/http.js') }}?v={{ static_version }}";
  const form = document.getElementById('loginForm');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    try {
      await api('/auth/login', { method: 'POST', body: { username, password } });
      window.location.href = "{{ url_for('pages_user.dashboard') }}";
    } catch (err) {
      alert(err?.message || 'Error de autenticación');
    }
  });
</script>
{% endblock %}