{% extends 'auth_base.html' %}
{% block title %}SIIAP – Iniciar Sesión{% endblock %}

{% block container_class %}login-container{% endblock %}

{% block styles %}
  {{ super() }}
  <link href="{{ url_for('static', filename='css/auth/login.css') }}?v={{ static_version }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="card">
  <div class="card-body">
    <h3 class="card-title text-center mb-4">Iniciar Sesión</h3>
    <hr class="mx-3">

    <form id="loginForm">
      <div class="mb-3">
        <label for="username" class="form-label">Usuario</label>
        <input type="text" class="form-control" id="username" name="username" required autofocus>
      </div>
      <div class="mb-3">
        <label for="password" class="form-label">Contraseña</label>
        <input type="password" class="form-control" id="password" name="password" required>
      </div>
      <button type="submit" class="btn btn-primary w-100 bg-tecnm">Entrar</button>
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    </form>

    <div class="mt-3 text-center">
      ¿No tienes cuenta? <a href="{{ url_for('pages_auth.register_page') }}" data-no-swup>Regístrate</a>
    </div>
  </div>
</div>

<script type="module">
  import { api } from "{{ url_for('static', filename='js/api/http.js') }}?v={{ static_version }}";
  const form = document.getElementById('loginForm');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    try {
      await api('/auth/login', { method: 'POST', body: { username, password } });
      window.location.href = "{{ url_for('pages_user.dashboard') }}";
    } catch (err) {
      window.dispatchEvent(new CustomEvent('flash', { 
        detail: { level: 'danger', message: err?.message || 'Error de autenticación' }
      }));
    }
  });
</script>
{% endblock %}