{% extends 'base.html' %}

{% block title %}{{super()}} - Perfil{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/user/profile.css') }}?v=1.1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Contenido principal -->
        <main class="col-md-12">
            <!-- Cabecera del perfil -->
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="position-relative mb-3">
                                <img src="{{ current_user.avatar_url }}" alt="Foto de perfil"
                                    class="rounded-circle border border-3 border-light shadow profile-avatar">
                                {% if current_user.role.name in ['program_admin', 'postgraduate_admin'] %}
                                <span
                                    class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                    Admin
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="mb-0">{{ current_user.first_name }} {{ current_user.last_name }} 
                                    {% if current_user.mother_last_name %}{{ current_user.mother_last_name }}{% endif %}</h2>
                                <button class="btn btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#editProfileModal">
                                    <i class="bi bi-pencil-fill me-2"></i>
                                    Editar Perfil
                                </button>
                            </div>
                            <p class="text-muted">
                                {% if current_user.role.name == 'applicant' %}
                                Aspirante
                                {% elif current_user.role.name == 'social_service' %}
                                Servicio Social
                                {% elif current_user.role.name == 'program_admin' %}
                                Administrador de Programa
                                {% elif current_user.role.name == 'postgraduate_admin' %}
                                Administrador de Posgrado
                                {% endif %}
                            </p>

                            <div class="mb-3">
                                <span class="badge bg-success me-2">Activo</span>
                                {% if current_user.is_internal %}
                                <span class="badge bg-info me-2">Usuario Interno</span>
                                {% endif %}
                                {% if current_user.role.name in ['program_admin', 'postgraduate_admin'] %}
                                <span class="badge bg-danger me-2">Admin</span>
                                {% endif %}
                                {% if current_user.scolarship_type and current_user.scolarship_type != 'none'%}
                                <span class="badge bg-primary">Beca: {{ current_user.scolarship_type }}</span>
                                {% endif %}
                            </div>

                            <div class="row g-3 mb-3">
                                {% if current_user.user_program %}
                                {% set up = current_user.user_program|first %}
                                <div class="col-md-3 col-6">
                                    <div class="border rounded p-3 text-center">
                                        <h3 class="mb-1">{{ up.program.slug }}</h3>
                                        <small class="text-muted">Programa</small>
                                    </div>
                                </div>
                                {% endif %}
                                <div class="col-md-3 col-6">
                                    <div class="border rounded p-3 text-center">
                                        <h3 class="mb-1">{{ current_user.last_login.strftime('%d/%m/%Y') }}</h3>
                                        <small class="text-muted">Último acceso</small>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="border rounded p-3 text-center">
                                        <h3 class="mb-1">{{ current_user.registration_date.strftime('%d/%m/%Y') }}</h3>
                                        <small class="text-muted">Fecha de registro</small>
                                    </div>
                                </div>
                                {% if current_user.role.name in ['program_admin', 'postgraduate_admin'] %}
                                <div class="col-md-3 col-6">
                                    <div class="border rounded p-3 text-center">
                                        <h3 class="mb-1">
                                            <i class="bi bi-shield-check"></i>
                                        </h3>
                                        <small class="text-muted">Administrador</small>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navegación de pestañas -->
            <ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-tab-pane"
                        type="button" role="tab" aria-controls="info-tab-pane" aria-selected="true">
                        <i class="bi bi-person me-2"></i>Información Personal
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="academic-tab" data-bs-toggle="tab" data-bs-target="#academic-tab-pane"
                        type="button" role="tab" aria-controls="academic-tab-pane" aria-selected="false">
                        <i class="bi bi-mortarboard me-2"></i>Información Académica
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="documents-tab" data-bs-toggle="tab"
                        data-bs-target="#documents-tab-pane" type="button" role="tab" aria-controls="documents-tab-pane"
                        aria-selected="false">
                        <i class="bi bi-file-earmark-text me-2"></i>Documentos
                    </button>
                </li>
                {% if current_user.role.name in ['program_admin', 'postgraduate_admin'] %}
                <li class="nav-item" role="presentation">
                    <button class="nav-link text-danger" id="admin-tab" data-bs-toggle="tab"
                        data-bs-target="#admin-tab-pane" type="button" role="tab" aria-controls="admin-tab-pane"
                        aria-selected="false">
                        <i class="bi bi-shield me-2"></i>Panel de Administración
                    </button>
                </li>
                {% endif %}
            </ul>

            <!-- Contenido de las pestañas -->
            <div class="tab-content" id="profileTabsContent">
                <!-- Información Personal -->
                <div class="tab-pane fade show active" id="info-tab-pane" role="tabpanel" aria-labelledby="info-tab"
                    tabindex="0">
                    {% include 'user/profile/_profile_info.html' %}
                </div>

                <!-- Información Académica -->
                <div class="tab-pane fade" id="academic-tab-pane" role="tabpanel" aria-labelledby="academic-tab"
                    tabindex="0">
                    {% include 'user/profile/_profile_academic.html' %}
                </div>

                <!-- Documentos -->
                <div class="tab-pane fade" id="documents-tab-pane" role="tabpanel" aria-labelledby="documents-tab"
                    tabindex="0">
                    {% include 'user/profile/_profile_documents.html' %}
                </div>

                <!-- Panel de Administración -->
                {% if current_user.role.name in ['program_admin', 'postgraduate_admin'] %}
                <div class="tab-pane fade" id="admin-tab-pane" role="tabpanel" aria-labelledby="admin-tab" tabindex="0">
                    {% include 'user/profile/_profile_admin.html' %}
                </div>
                {% endif %}
            </div>
        </main>
    </div>
</div>


<!-- Modal para editar perfil -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProfileModalLabel">Editar perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('user.profile') }}" method="POST">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="first_name" class="form-label">Nombre</label>
                            <input type="text" class="form-control" id="first_name" name="first_name"
                                value="{{ current_user.first_name }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="last_name" class="form-label">Apellido Paterno</label>
                            <input type="text" class="form-control" id="last_name" name="last_name"
                                value="{{ current_user.last_name }}" required>
                        </div>
                        <div class="col-md-4">
                            <label for="mother_last_name" class="form-label">Apellido Materno (Opcional)</label>
                            <input type="text" class="form-control" id="mother_last_name" name="mother_last_name"
                                value="{{ current_user.mother_last_name }}">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        Guardar cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/user/profile.js') }}"></script>
{% endblock %}