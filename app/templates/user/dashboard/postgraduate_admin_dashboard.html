<!-- Dashboard para Postgraduate Admin -->

<!-- Pestañas de navegación -->
<ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview"
                type="button" role="tab" aria-controls="overview" aria-selected="true">
            <i class="bi bi-speedometer2 me-2"></i>Vista General
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="programs-tab" data-bs-toggle="tab" data-bs-target="#programs"
                type="button" role="tab" aria-controls="programs" aria-selected="false">
            <i class="bi bi-mortarboard me-2"></i>Programas
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="reminders-tab" data-bs-toggle="tab" data-bs-target="#reminders"
                type="button" role="tab" aria-controls="reminders" aria-selected="false">
            <i class="bi bi-bell me-2"></i>Recordatorios
        </button>
    </li>
</ul>

<!-- Contenido de las pestañas -->
<div class="tab-content" id="adminTabsContent">
    <!-- ============ PESTAÑA: VISTA GENERAL ============ -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
        <!-- Acciones Rápidas -->
        <div class="row mb-4">
            <div class="col-12">
                <h5 class="mb-3 fw-bold text-secondary">
                    <i class="bi bi-lightning-charge-fill me-2"></i>Acciones Rápidas
                </h5>
                <div class="row g-3">
                    <!-- Gestionar Usuarios -->
                    <div class="col-md-3 col-sm-6">
                        <a href="{{ url_for('pages_admin.pages_settings.users') }}"
                           class="text-decoration-none">
                            <div class="card h-100 border-0 shadow-sm quick-action-card">
                                <div class="card-body text-center py-4">
                                    <div class="mb-3">
                                        <i class="bi bi-people-fill text-primary" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h6 class="mb-1 fw-bold">Gestionar Usuarios</h6>
                                    <small class="text-muted">Administrar usuarios</small>
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Configuración de Correos -->
                    <div class="col-md-3 col-sm-6">
                        <a href="{{ url_for('pages_admin.pages_emails.email_config') }}"
                           class="text-decoration-none">
                            <div class="card h-100 border-0 shadow-sm quick-action-card">
                                <div class="card-body text-center py-4">
                                    <div class="mb-3">
                                        <i class="bi bi-envelope-fill text-success" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h6 class="mb-1 fw-bold">Configurar Correos</h6>
                                    <small class="text-muted">Microsoft Graph</small>
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Ver Todos los Programas -->
                    <div class="col-md-3 col-sm-6">
                        <a href="{{ url_for('program.list_programs') }}"
                           class="text-decoration-none">
                            <div class="card h-100 border-0 shadow-sm quick-action-card">
                                <div class="card-body text-center py-4">
                                    <div class="mb-3">
                                        <i class="bi bi-mortarboard text-info" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h6 class="mb-1 fw-bold">Ver Programas</h6>
                                    <small class="text-muted">Todos los programas</small>
                                </div>
                            </div>
                        </a>
                    </div>

                    <!-- Configuración General -->
                    <div class="col-md-3 col-sm-6">
                        <a href="{{ url_for('pages_admin.pages_settings.index') }}"
                           class="text-decoration-none">
                            <div class="card h-100 border-0 shadow-sm quick-action-card">
                                <div class="card-body text-center py-4">
                                    <div class="mb-3">
                                        <i class="bi bi-gear-fill text-warning" style="font-size: 2.5rem;"></i>
                                    </div>
                                    <h6 class="mb-1 fw-bold">Configuración</h6>
                                    <small class="text-muted">Ajustes del sistema</small>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- KPIs Globales -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card border-0 shadow-sm h-100 kpi-card">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-grid-3x3-gap-fill text-primary" style="font-size: 2.5rem;"></i>
                        </div>
                        <h2 class="mb-0 fw-bold text-primary">{{ metrics.total_programs }}</h2>
                        <p class="text-muted mb-0 small">Programas Activos</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card border-0 shadow-sm h-100 kpi-card">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-person-lines-fill text-info" style="font-size: 2.5rem;"></i>
                        </div>
                        <h2 class="mb-0 fw-bold text-info">{{ metrics.total_applicants }}</h2>
                        <p class="text-muted mb-0 small">Solicitantes Totales</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card border-0 shadow-sm h-100 kpi-card">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-mortarboard-fill text-success" style="font-size: 2.5rem;"></i>
                        </div>
                        <h2 class="mb-0 fw-bold text-success">{{ metrics.total_students }}</h2>
                        <p class="text-muted mb-0 small">Estudiantes Activos</p>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card border-0 shadow-sm h-100 kpi-card">
                    <div class="card-body text-center">
                        <div class="mb-2">
                            <i class="bi bi-hourglass-split text-warning" style="font-size: 2.5rem;"></i>
                        </div>
                        <h2 class="mb-0 fw-bold text-warning">{{ metrics.pending_reviews }}</h2>
                        <p class="text-muted mb-0 small">Documentos Pendientes</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resumen Ejecutivo -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-header bg-white border-0 pt-4 pb-3">
                        <h5 class="mb-0 fw-bold">
                            <i class="bi bi-bar-chart-fill text-primary me-2"></i>Resumen Ejecutivo
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <h4 class="mb-0 text-primary fw-bold">
                                        {{ ((metrics.total_students / (metrics.total_applicants if metrics.total_applicants > 0 else 1)) * 100)|round|int }}%
                                    </h4>
                                    <small class="text-muted">Tasa de Admisión</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <h4 class="mb-0 text-success fw-bold">
                                        {{ (metrics.total_applicants / (metrics.total_programs if metrics.total_programs > 0 else 1))|round|int }}
                                    </h4>
                                    <small class="text-muted">Promedio por Programa</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <h4 class="mb-0 text-warning fw-bold">
                                        {{ metrics.interviews_pending }}
                                    </h4>
                                    <small class="text-muted">Entrevistas Pendientes</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ PESTAÑA: PROGRAMAS ============ -->
    <div class="tab-pane fade" id="programs" role="tabpanel" aria-labelledby="programs-tab">
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-header bg-white border-0 pt-4 pb-3">
                        <h5 class="mb-0 fw-bold">
                            <i class="bi bi-mortarboard text-primary me-2"></i>Estadísticas por Programa
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if metrics.programs_stats %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Programa</th>
                                        <th class="text-center">Solicitantes</th>
                                        <th class="text-center">Docs. Pendientes</th>
                                        <th class="text-center">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for prog in metrics.programs_stats %}
                                    <tr>
                                        <td>
                                            <strong>{{ prog.name }}</strong>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-primary rounded-pill">{{ prog.applicants }}</span>
                                        </td>
                                        <td class="text-center">
                                            {% if prog.pending_docs > 0 %}
                                                <span class="badge bg-warning text-dark rounded-pill">{{ prog.pending_docs }}</span>
                                            {% else %}
                                                <span class="badge bg-success rounded-pill">0</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <a href="{{ url_for('program.view_program', slug=prog.slug) }}"
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> Ver
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-3 mb-0">No hay programas registrados</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============ PESTAÑA: RECORDATORIOS ============ -->
    <div class="tab-pane fade" id="reminders" role="tabpanel" aria-labelledby="reminders-tab">
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-header bg-white border-0 pt-4 pb-3">
                        <h5 class="mb-0 fw-bold">
                            <i class="bi bi-bell text-warning me-2"></i>Recordatorios del Sistema
                        </h5>
                    </div>
                    <div class="card-body" id="reminders-container">
                        <!-- Spinner de carga mientras verificamos -->
                        <div class="text-center py-4" id="loading-reminders">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="text-muted mt-3">Verificando configuración...</p>
                        </div>

                        <!-- Contenedor de recordatorios -->
                        <div id="reminders-list" style="display: none;">
                            <!-- Los recordatorios se cargarán aquí con JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estilos adicionales -->
<style>
.quick-action-card {
    transition: all 0.3s ease;
    cursor: pointer;
}

.quick-action-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.kpi-card {
    transition: all 0.3s ease;
}

.kpi-card:hover {
    transform: scale(1.02);
}

.nav-tabs .nav-link {
    color: #6c757d;
    font-weight: 500;
}

.nav-tabs .nav-link.active {
    color: #0d6efd;
    font-weight: 600;
}
</style>

<!-- JavaScript para verificar configuración de correo -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Verificar configuración de correo cuando se abre la pestaña de recordatorios
    const remindersTab = document.getElementById('reminders-tab');
    const remindersList = document.getElementById('reminders-list');
    const loadingReminders = document.getElementById('loading-reminders');

    remindersTab.addEventListener('click', function() {
        checkEmailConfiguration();
    });

    async function checkEmailConfiguration() {
        try {
            const response = await fetch('/api/v1/emails/status');
            const data = await response.json();

            const reminders = [];

            // Verificar si hay correo configurado
            if (!data.data.connected || !data.data.account) {
                reminders.push({
                    type: 'warning',
                    icon: 'bi-envelope-x',
                    title: 'Correo no configurado',
                    message: 'No hay una cuenta de correo configurada. Los correos no se enviarán hasta que configures Microsoft Graph.',
                    action: {
                        text: 'Configurar ahora',
                        url: '{{ url_for("pages_admin.pages_settings.mails") }}'
                    }
                });
            } else {
                reminders.push({
                    type: 'success',
                    icon: 'bi-envelope-check',
                    title: 'Correo configurado correctamente',
                    message: `Cuenta activa: ${data.data.account.username || 'No disponible'}`,
                    action: null
                });
            }

            // Verificar documentos pendientes
            if ({{ metrics.pending_reviews }} > 0) {
                reminders.push({
                    type: 'info',
                    icon: 'bi-hourglass-split',
                    title: 'Documentos pendientes de revisión',
                    message: 'Hay {{ metrics.pending_reviews }} documentos esperando revisión en todos los programas.',
                    action: null
                });
            }

            // Renderizar recordatorios
            renderReminders(reminders);

        } catch (error) {
            console.error('Error al verificar configuración:', error);
            remindersList.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Error al cargar recordatorios. Por favor, recarga la página.
                </div>
            `;
        } finally {
            loadingReminders.style.display = 'none';
            remindersList.style.display = 'block';
        }
    }

    function renderReminders(reminders) {
        if (reminders.length === 0) {
            remindersList.innerHTML = `
                <div class="text-center py-4">
                    <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-success">¡Todo en orden!</h5>
                    <p class="text-muted mb-0">No hay recordatorios pendientes</p>
                </div>
            `;
            return;
        }

        let html = '';
        reminders.forEach(reminder => {
            const alertClass = {
                'success': 'alert-success',
                'warning': 'alert-warning',
                'info': 'alert-info',
                'danger': 'alert-danger'
            }[reminder.type] || 'alert-secondary';

            html += `
                <div class="alert ${alertClass} d-flex align-items-start mb-3">
                    <div class="flex-shrink-0 me-3">
                        <i class="bi ${reminder.icon}" style="font-size: 2rem;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-1">${reminder.title}</h6>
                        <p class="mb-0">${reminder.message}</p>
                        ${reminder.action ? `
                            <a href="${reminder.action.url}" class="btn btn-sm btn-${reminder.type === 'warning' ? 'warning' : reminder.type} mt-2">
                                ${reminder.action.text} <i class="bi bi-arrow-right ms-1"></i>
                            </a>
                        ` : ''}
                    </div>
                </div>
            `;
        });

        remindersList.innerHTML = html;
    }
});
</script>
